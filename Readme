PermiFlow — Captez le pouls de la ville

PermiFlow est une plateforme web pour parier sur l’évolution immobilière au niveau local à partir des permis de construire et autres données publiques.
Ce README décrit comment configurer, lancer et déployer l’application.

1. Prérequis

Node.js ≥ 20

npm ou yarn

Python 3.11+ (pour le scraping et scoring)

Compte Supabase

Compte Stripe (mode test suffisant)

Git

Vercel account pour le déploiement

2. Installation locale

Cloner le repo :

git clone https://github.com/<votre-user>/permiflow.git
cd permiflow/apps/web


Installer les dépendances :

npm install
# ou
yarn install


Créer un fichier .env.local à la racine de apps/web :

NEXT_PUBLIC_SUPABASE_URL=<votre_supabase_url>
NEXT_PUBLIC_SUPABASE_ANON_KEY=<votre_supabase_anon_key>
SUPABASE_SERVICE_ROLE_KEY=<votre_service_role_key>
STRIPE_SECRET_KEY=<votre_stripe_secret_key>
STRIPE_PUBLISHABLE_KEY=<votre_stripe_publishable_key>

3. Configuration Supabase

Créer un projet Supabase.

Exécuter le script SQL pour créer la base de données :

psql -h <host> -U <user> -d <db> -f infra/supabase/schema.sql
psql -h <host> -U <user> -d <db> -f infra/supabase/seed.sql


Vérifier que les tables users, bets, towns sont bien créées.

Vérifier les règles RLS si activées (ex : public par défaut pour dev).

4. Configuration Stripe

Créer un compte Stripe et activer le mode test.

Créer un produit “PermiFlow Credits” ou “Abonnement Pro”.

Copier les clé API dans le .env.local.

Vérifier que les webhooks pointent vers /api/payments/webhook.

5. Lancer l’application localement
# Backend et API serverless
npm run dev
# ou
yarn dev


URL frontend : http://localhost:3000

API endpoints :

/api/bets/route.ts — création et consultation des paris

/api/score/route.ts — scoring en temps réel

/api/settle/route.ts — clôture des paris

/api/payments/checkout/route.ts — paiement

/api/payments/webhook/route.ts — webhook Stripe

6. Scraping et scoring nocturne

1. Scraping SITADEL et autres sources

cd worker/scraper
python scrape_sitadel.py


Génère un CSV JSON par IRIS.

Met à jour Supabase avec la table towns.

2. Score nocturne

cd worker/model
python score_nightly.py


Réentraînement du modèle XGBoost

Mise à jour des scores hype-factor 0-100 pour chaque IRIS

Astuce : Ajouter un cron job (Linux/macOS) ou planificateur Windows pour exécuter chaque nuit.

7. Déploiement sur Vercel

Créer un projet Vercel et connecter le repo GitHub.

Configurer les variables d’environnement (Supabase, Stripe).

Déployer (vercel --prod ou via dashboard).

Vérifier le build automatique et que /api/* fonctionne.

8. Structure du projet
permiflow/
├─ apps/web/                  # Frontend NextJS
│  ├─ app/
│  ├─ components/
│  ├─ pages/
│  ├─ styles/
│  └─ public/
├─ worker/
│  ├─ scraper/                # Scraper SITADEL
│  └─ model/                  # Scoring XGBoost
├─ infra/supabase/            # SQL schema + seed
├─ scripts/                   # Scripts utilitaires
├─ services/                  # Librairies Stripe / Supabase
├─ .github/workflows/         # CI/CD
├─ package.json
└─ README.md

9. Commandes utiles
Commande	Description
npm run dev	Lancer le frontend + API local
npm run build	Builder NextJS pour prod
npm run start	Lancer build prod local
python worker/scraper/scrape_sitadel.py	Mettre à jour la DB avec les permis
python worker/model/score_nightly.py	Calculer scores hype-factor
vercel --prod	Déployer sur Vercel
10. Check-list pour Cursor

Cloner le repo.

Installer les dépendances npm.

Générer .env.local avec Supabase + Stripe.

Vérifier schema.sql + seed.sql.

Lancer API et frontend avec npm run dev.

Lancer scrape_sitadel.py et score_nightly.py.

Tester flux pari et wallet avec Stripe test.

Déployer sur Vercel.

11. Notes

Version MVP : serverless PWA, sans apps natives.

Limites free tier (Supabase, Vercel) : 1 000 utilisateurs max.

Code généré via Manus / Cursor : prévoir relecture sécurité + test.

Les paris respectent la limite légale (< 1 850 €/personne/an) pour rester en « pari mutuel ».
